<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Micro Apps | Home</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./shared/shell/shell.css" />
  <style>
    :root {
      --bg: #060a1a;
      --panel: rgba(8, 13, 32, 0.8);
      --panel-strong: #0d1430;
      --border: rgba(148, 163, 184, 0.28);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --brand-1: #22d3ee;
      --brand-2: #818cf8;
      --brand-3: #38bdf8;
      --positive: #10b981;
      --radius: 18px;
      --radius-sm: 12px;
      --shadow: 0 20px 60px rgba(2, 6, 23, 0.55);
      --max-width: 1200px;
      font-family: 'Inter', system-ui, sans-serif;
    }

    * { box-sizing: border-box; }

    body.home-theme {
      margin: 0;
      color: var(--text);
      min-height: 100vh;
      background:
        radial-gradient(circle at 12% 10%, rgba(34, 211, 238, 0.2), transparent 34%),
        radial-gradient(circle at 90% 15%, rgba(129, 140, 248, 0.18), transparent 36%),
        radial-gradient(circle at 40% 95%, rgba(56, 189, 248, 0.15), transparent 36%),
        linear-gradient(180deg, #020617 0%, #060a1a 100%);
    }

    body.home-theme .app-frame {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 28px 20px 56px;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .hero {
      position: relative;
      overflow: hidden;
      border-radius: 28px;
      border: 1px solid rgba(56, 189, 248, 0.3);
      background:
        linear-gradient(120deg, rgba(34, 211, 238, 0.15), rgba(129, 140, 248, 0.18)),
        rgba(8, 13, 32, 0.72);
      padding: 34px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      align-items: center;
    }

    .hero::after {
      content: '';
      position: absolute;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      right: -80px;
      top: -95px;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.3), rgba(56, 189, 248, 0));
      pointer-events: none;
    }

    .kicker {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      border: 1px solid rgba(56, 189, 248, 0.38);
      background: rgba(56, 189, 248, 0.12);
      color: #a5f3fc;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .hero h2 { margin: 0 0 8px; font-size: 2.1rem; line-height: 1.1; letter-spacing: -0.02em; }
    .hero p { margin: 0; color: #cbd5e1; }

    .hero-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      gap: 8px;
      padding: 11px 15px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.65);
      color: var(--text);
      font-weight: 700;
    }

    .button.primary {
      border: none;
      background: linear-gradient(135deg, var(--brand-1), var(--brand-2));
      color: #020617;
    }

    .stats-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }

    .stat-chip {
      border-radius: 11px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(15, 23, 42, 0.65);
      padding: 8px 12px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .controls-panel {
      border: 1px solid rgba(56, 189, 248, 0.24);
      border-radius: 16px;
      background: rgba(2, 6, 23, 0.52);
      backdrop-filter: blur(8px);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .controls-row { display: flex; flex-wrap: wrap; gap: 10px; }

    .search-input,
    .select-input {
      border-radius: 11px;
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--text);
      padding: 11px 13px;
      font: inherit;
    }

    .search-input { flex: 1; min-width: 220px; }

    .filters { display: flex; flex-wrap: wrap; gap: 9px; }

    .filter-chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #111827;
      color: #cbd5e1;
      font-weight: 600;
      padding: 7px 12px;
      cursor: pointer;
    }

    .filter-chip.active {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(129, 140, 248, 0.2));
      border-color: rgba(56, 189, 248, 0.5);
      color: #a5f3fc;
    }

    .results-meta {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .section-heading {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin: 8px 0;
    }

    .section-heading h3 { margin: 0; font-size: 1.2rem; }
    .featured-label { color: #a5f3fc; font-weight: 800; }
    .card-description { margin: 0; color: var(--muted); }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      width: 100%;
    }

    .app-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(155deg, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.72));
      box-shadow: 0 16px 38px rgba(2, 6, 23, 0.45);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 160ms ease, border-color 160ms ease;
    }

    .app-card:hover,
    .app-card:focus-within { transform: translateY(-3px); border-color: rgba(56, 189, 248, 0.6); }

    .thumb {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: linear-gradient(140deg, #1e293b, #0f172a);
    }

    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .badge-row,
    .tag-list,
    .meta { display: flex; flex-wrap: wrap; gap: 8px; }

    .badge,
    .tag-list li,
    .status-pill {
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.82rem;
      font-weight: 700;
    }

    .badge { border: 1px solid transparent; }
    .badge.accent { background: rgba(34, 211, 238, 0.2); color: #a5f3fc; }
    .badge.neutral { background: rgba(148, 163, 184, 0.15); color: #cbd5e1; }
    .badge.updated { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
    .badge.new { background: rgba(251, 146, 60, 0.2); color: #fdba74; }

    .card-header { display: flex; justify-content: space-between; gap: 10px; }
    .card-title { margin: 0; font-size: 1.16rem; }

    .status-pill {
      border: 1px solid rgba(129, 140, 248, 0.4);
      color: #c7d2fe;
      background: rgba(129, 140, 248, 0.14);
      white-space: nowrap;
    }

    .tag-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .tag-list li {
      border: 1px solid rgba(148, 163, 184, 0.26);
      background: rgba(15, 23, 42, 0.72);
      color: #cbd5e1;
    }

    .meta { color: var(--muted); font-weight: 600; font-size: 0.9rem; }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 34px 12px;
      border-radius: 14px;
      border: 1px dashed var(--border);
      color: var(--muted);
      font-weight: 700;
      background: rgba(15, 23, 42, 0.55);
    }

    .footer-links {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      color: var(--muted);
    }

    .footer-links a {
      color: #a5f3fc;
      font-weight: 700;
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .hero { padding: 24px; }
      .controls-row { flex-direction: column; align-items: stretch; }
      .card-footer { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div id="app-root"></div>
  <script type="module">
    import { mountShell, registerServiceWorker } from './shared/shell/shell.js';
    import { formatDate } from './shared/utils/format.js';

    document.body.classList.add('home-theme');

    const manifestUrl = './apps/apps.json';
    const defaultThumb = './assets/images/thumbnails/app-placeholder.svg';

    const { content, frame } = mountShell({
      appTitle: 'Micro Apps',
      appTagline: 'Small apps, polished interactions, shared shell',
      navLinks: [
        { href: '#apps', label: 'Apps', current: true },
        { href: '#featured', label: 'Featured' },
        { href: 'https://github.com/brickfielder/micro-apps', label: 'GitHub' },
      ],
      includeHomeLink: false,
      includeHeader: false,
    });

    const footer = frame.querySelector('.app-footer');
    if (footer) {
      footer.innerHTML = `
        <div class="footer-links">
          <span>Built for fast practice and experimentation.</span>
          <div class="footer-actions">
            <a href="https://github.com/brickfielder/micro-apps" target="_blank" rel="noreferrer">GitHub</a>
            <a href="https://brickfielder.github.io/micro-apps/docs" target="_blank" rel="noreferrer">Docs</a>
            <a href="mailto:hello@example.com">Contact</a>
          </div>
        </div>
      `;
    }

    const hero = document.createElement('section');
    hero.className = 'hero';
    hero.innerHTML = `
      <div>
        <span class="kicker">✨ Refreshed Home Experience</span>
        <h2>Discover focused mini-apps designed for quick skill building.</h2>
        <p>Search by topic, filter by category, and launch each app in one click. The home page now highlights your best starting points with cleaner visuals and clearer metadata.</p>
        <div class="hero-actions">
          <a class="button primary" href="#apps">Explore apps</a>
          <a class="button" href="https://github.com/brickfielder/micro-apps" target="_blank" rel="noreferrer">View source</a>
        </div>
        <div class="stats-row" id="hero-stats"></div>
      </div>
      <div>
        <div class="controls-panel" aria-label="Quick filters">
          <div class="controls-row">
            <input class="search-input" type="search" placeholder="Search by name, purpose, or tag" aria-label="Search apps" />
            <select class="select-input" aria-label="Sort apps">
              <option value="featured">Featured first</option>
              <option value="alpha">A to Z</option>
              <option value="recent">Recently updated</option>
              <option value="status">Status</option>
            </select>
          </div>
          <div class="filters" aria-label="Filter by category" role="group"></div>
          <div class="results-meta">
            <span id="result-count">Loading apps...</span>
            <span id="active-filter"></span>
          </div>
        </div>
      </div>
    `;

    const searchInput = hero.querySelector('.search-input');
    const sortSelect = hero.querySelector('select');
    const filtersBar = hero.querySelector('.filters');
    const resultCount = hero.querySelector('#result-count');
    const activeFilter = hero.querySelector('#active-filter');
    const statsRow = hero.querySelector('#hero-stats');

    content.appendChild(hero);

    const featuredSection = document.createElement('section');
    featuredSection.id = 'featured';
    featuredSection.innerHTML = `
      <div class="section-heading">
        <h3><span class="featured-label">⭐ Featured Apps</span></h3>
        <p class="card-description">Best first picks for most users.</p>
      </div>
      <div class="card-grid" id="featured-grid"></div>
    `;

    const appsSection = document.createElement('section');
    appsSection.id = 'apps';
    appsSection.innerHTML = `
      <div class="section-heading">
        <h3>All Apps</h3>
        <p class="card-description">Search, filter, and launch any available micro-app.</p>
      </div>
      <div class="card-grid" id="apps-grid"></div>
    `;

    content.append(featuredSection, appsSection);

    const featuredGrid = featuredSection.querySelector('#featured-grid');
    const appsGrid = appsSection.querySelector('#apps-grid');

    let allApps = [];
    let selectedTag = 'all';

    const sorters = {
      featured: (a, b) => Number(b.featured) - Number(a.featured) || sorters.recent(a, b),
      alpha: (a, b) => a.title.localeCompare(b.title),
      recent: (a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated),
      status: (a, b) => (a.status || '').localeCompare(b.status || ''),
    };

    function buildTagFilters(tags) {
      filtersBar.replaceChildren();
      const allButton = createTagButton('all', 'All categories');
      filtersBar.appendChild(allButton);
      tags.forEach((tag) => filtersBar.appendChild(createTagButton(tag, tag)));
    }

    function createTagButton(value, label) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'filter-chip' + (value === selectedTag ? ' active' : '');
      btn.textContent = label;
      btn.dataset.value = value;
      btn.addEventListener('click', () => {
        selectedTag = value;
        updateActiveFilter();
        render();
      });
      return btn;
    }

    function updateStats(apps) {
      statsRow.replaceChildren();
      const total = document.createElement('span');
      total.className = 'stat-chip';
      total.textContent = `${apps.length} total apps`;
      const featuredCount = document.createElement('span');
      featuredCount.className = 'stat-chip';
      featuredCount.textContent = `${apps.filter((app) => app.featured).length} featured`;
      const updated = document.createElement('span');
      updated.className = 'stat-chip';
      updated.textContent = `${apps.filter((app) => app.badge === 'Updated' || app.badge === 'New').length} new/updated`;
      statsRow.append(total, featuredCount, updated);
    }

    function updateActiveFilter() {
      activeFilter.textContent = selectedTag === 'all' ? 'Showing every category' : `Filtering by ${selectedTag}`;
      filtersBar.querySelectorAll('.filter-chip').forEach((chip) => {
        chip.classList.toggle('active', chip.dataset.value === selectedTag);
      });
    }

    function createCard(app) {
      const card = document.createElement('article');
      card.className = 'app-card';
      card.tabIndex = 0;

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      const img = document.createElement('img');
      img.src = app.thumbnail || defaultThumb;
      img.alt = `${app.title} preview`;
      thumb.appendChild(img);

      const badges = document.createElement('div');
      badges.className = 'badge-row';
      if (app.featured) {
        const badge = document.createElement('span');
        badge.className = 'badge accent';
        badge.textContent = 'Featured';
        badges.appendChild(badge);
      }
      if (app.badge) {
        const badge = document.createElement('span');
        badge.className = 'badge ' + app.badge.toLowerCase();
        badge.textContent = app.badge;
        badges.appendChild(badge);
      }

      const header = document.createElement('div');
      header.className = 'card-header';

      const title = document.createElement('h3');
      title.className = 'card-title';
      title.textContent = app.title;

      const status = document.createElement('span');
      status.className = 'status-pill';
      status.textContent = app.status || 'Ready';

      header.append(title, status);

      const description = document.createElement('p');
      description.className = 'card-description';
      description.textContent = app.description;

      const tags = document.createElement('ul');
      tags.className = 'tag-list';
      (app.tags || []).forEach((tag) => {
        const item = document.createElement('li');
        item.textContent = tag;
        tags.appendChild(item);
      });

      const meta = document.createElement('div');
      meta.className = 'meta';
      const version = document.createElement('span');
      version.textContent = `v${app.version || '1.0'}`;
      const updated = document.createElement('span');
      updated.textContent = `Updated ${formatDate(app.lastUpdated)}`;
      meta.append(version, updated);

      const footer = document.createElement('div');
      footer.className = 'card-footer';
      const offline = document.createElement('span');
      offline.className = 'badge neutral';
      offline.textContent = app.offlineCapable ? 'Offline ready' : 'Online only';

      const launch = document.createElement('a');
      launch.className = 'button primary';
      launch.href = app.entryPath;
      launch.target = '_blank';
      launch.rel = 'noreferrer';
      launch.textContent = 'Launch app';

      footer.append(offline, launch);
      card.append(thumb, badges, header, description, tags, meta, footer);
      return card;
    }

    function renderFeatured(apps) {
      featuredGrid.replaceChildren();
      featuredSection.style.display = apps.length ? 'block' : 'none';
      apps.forEach((app) => featuredGrid.appendChild(createCard(app)));
    }

    function renderApps(apps) {
      appsGrid.replaceChildren();
      if (!apps.length) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = 'No apps match this search or filter yet.';
        appsGrid.appendChild(empty);
        return;
      }
      apps.forEach((app) => appsGrid.appendChild(createCard(app)));
    }

    function render() {
      const query = searchInput.value.toLowerCase();
      const sortKey = sortSelect.value;

      const filtered = allApps.filter((app) => {
        const matchesQuery =
          app.title.toLowerCase().includes(query) ||
          app.description.toLowerCase().includes(query) ||
          (app.tags || []).some((tag) => tag.toLowerCase().includes(query));
        const matchesTag = selectedTag === 'all' || (app.tags || []).includes(selectedTag);
        return matchesQuery && matchesTag;
      });

      const sorted = [...filtered].sort(sorters[sortKey] || sorters.featured);
      const featuredApps = sorted.filter((app) => app.featured).slice(0, 4);
      const featuredSlugs = new Set(featuredApps.map((app) => app.slug));
      const mainApps = sorted.filter((app) => !featuredSlugs.has(app.slug));

      resultCount.textContent = `${filtered.length} app${filtered.length === 1 ? '' : 's'} shown`;
      renderFeatured(featuredApps);
      renderApps(mainApps);
      updateActiveFilter();
    }

    async function loadApps() {
      try {
        const response = await fetch(manifestUrl);
        if (!response.ok) throw new Error('Could not load apps manifest');
        allApps = await response.json();

        const uniqueTags = Array.from(new Set(allApps.flatMap((app) => app.tags || []))).sort();
        buildTagFilters(uniqueTags);
        updateActiveFilter();
        updateStats(allApps);
        render();
      } catch (error) {
        console.error(error);
        resultCount.textContent = 'Failed to load apps';
        const errorState = document.createElement('div');
        errorState.className = 'empty-state';
        errorState.textContent = 'The manifest could not be loaded. Please try again later.';
        appsGrid.replaceChildren(errorState);
        featuredGrid.replaceChildren();
      }
    }

    searchInput.addEventListener('input', render);
    sortSelect.addEventListener('change', render);

    loadApps();
    registerServiceWorker();
  </script>
</body>
</html>
